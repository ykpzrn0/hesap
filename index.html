<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { 
            --bg: #000; --surface: #0a0a0a; --accent: #fff; --border: rgba(255,255,255,0.1); --text: #fff; 
            --prot: #4ade80; --fat: #facc15; --carb: #ef4444; 
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        
        body { background-color: var(--bg); color: var(--text); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 15px; }
        
        .container { width: 100%; max-width: 1000px; position: relative; }
        
        header { margin-bottom: 30px; border-left: 3px solid var(--accent); padding-left: 20px; }
        header h1 { font-size: clamp(20px, 5vw, 32px); }
        .brand { font-size: 10px; text-transform: uppercase; letter-spacing: 2px; opacity: 0.6; }

        /* Form Grupları */
        .field-group { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
            gap: 15px; 
            margin-bottom: 20px; 
        }
        
        label { font-size: 9px; font-weight: 800; text-transform: uppercase; color: #666; display: block; margin-bottom: 8px; letter-spacing: 1px; }
        input, select { background: var(--surface); border: 1px solid var(--border); color: #fff; padding: 12px; border-radius: 4px; outline: none; width: 100%; font-size: 14px; }

        /* Hedef Seçim Kartları */
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 30px; }
        .card { background: var(--surface); border: 1px solid var(--border); padding: 15px; border-radius: 4px; cursor: pointer; transition: 0.3s; text-align: center; }
        .card h3 { font-size: 13px; }
        .card p { font-size: 10px; opacity: 0.6; }
        .card.selected { background: var(--accent); color: #000; }

        /* Butonlar */
        .btn { padding: 18px 25px; font-weight: 800; text-transform: uppercase; cursor: pointer; border-radius: 4px; border: none; font-size: 11px; }
        .btn-main { background: var(--accent); color: #000; width: 100%; }

        /* Sonuç Paneli */
        #ui-result { display: none; margin-top: 20px; }
        #ui-result.active { display: block; }
        
        /* Çıktı Alınacak Alan - Export Esnasında Sabit Genişlik Verilecek */
        #report-area { 
            background: #000; 
            padding: 40px; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            display: grid; 
            grid-template-columns: 1.2fr 0.8fr; 
            gap: 30px;
            width: 100%;
        }

        .big-val { font-size: clamp(40px, 10vw, 70px); font-weight: 800; letter-spacing: -3px; margin: 10px 0; }
        .macro-container { display: flex; gap: 15px; margin: 20px 0; }
        .macro-box h3 { font-size: 22px; font-weight: 800; }

        .logic-item { padding: 12px; background: rgba(255,255,255,0.03); border-left: 2px solid var(--accent); margin-top: 10px; }
        .logic-item h5 { font-size: 9px; color: var(--accent); margin-bottom: 4px; }
        .logic-item p { font-size: 12px; color: #bbb; }

        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-top: 20px; }

        /* MOBİL AYARLARI */
        @media (max-width: 768px) {
            #report-area { grid-template-columns: 1fr; padding: 25px; }
            .grid { grid-template-columns: 1fr; }
            .chart-side { order: -1; }
            header { text-align: center; border: none; padding: 0; border-bottom: 2px solid var(--accent); padding-bottom: 10px; }
        }

        .chart-wrapper { position: relative; width: 260px; height: 260px; margin: 0 auto; }
    </style>
</head>
<body>

<div class="container">
    <div id="ui-setup">
        <header><span class="brand">Pro Nutrition Logic</span><h1>Analiz Sistemi.</h1></header>
        
        <div class="field-group">
            <div><label>İsim</label><input type="text" id="name" placeholder="Eray Yılmaz"></div>
            <div><label>Cinsiyet</label><select id="gen" onchange="toggleThemes()"><option value="none">Seçiniz</option><option value="male">Erkek</option><option value="female">Kadın</option></select></div>
            <div id="t-wrap" style="display:none;"><label>Tema</label><select id="t-pick" onchange="applyT()"></select></div>
        </div>

        <div class="field-group">
            <div><label>Kilo (kg)</label><input type="number" id="w"></div>
            <div><label>Boy (cm)</label><input type="number" id="h"></div>
            <div><label>Yaş</label><input type="number" id="a"></div>
        </div>

        <div class="field-group">
            <div><label>Hareketlilik</label><select id="freq"><option value="1.2">Az (1-2 gün)</option><option value="1.4" selected>Orta (3-4 gün)</option><option value="1.6">Çok (5-6 gün)</option><option value="1.8">Pro (7+ gün)</option></select></div>
            <div><label>Tür</label><select id="style"><option>Ağırlık</option><option>Kardiyo</option><option>HIIT</option></select></div>
        </div>

        <div class="grid">
            <div class="card" onclick="setG(this, 'fat')"><h3>Yağ Yakımı</h3><p>Defisit</p></div>
            <div class="card" onclick="setG(this, 'muscle')"><h3>Kas Artışı</h3><p>Surplus</p></div>
            <div class="card" onclick="setG(this, 'recomp')"><h3>Koruma</h3><p>Denge</p></div>
        </div>
        <button class="btn btn-main" onclick="calc()">Raporu Oluştur</button>
    </div>

    <div id="ui-result">
        <div id="report-area">
            <div class="info-side">
                <span class="brand">Biyometrik Sonuçlar</span>
                <div class="big-val" id="out-cal">0</div>
                <div class="macro-container">
                    <div class="macro-box"><label style="color:var(--prot)">Protein</label><h3 id="out-p">0</h3></div>
                    <div class="macro-box"><label style="color:var(--fat)">Yağ</label><h3 id="out-f">0</h3></div>
                    <div class="macro-box"><label style="color:var(--carb)">Karb</label><h3 id="out-c">0</h3></div>
                </div>
                <div class="logic-panel">
                    <div class="logic-item"><h5>Bakım Kalorisi</h5><p id="l-tdee"></p></div>
                    <div class="logic-item"><h5>Strateji</h5><p id="l-diff"></p></div>
                    <div class="logic-item"><h5>Analiz</h5><p id="l-reason"></p></div>
                </div>
            </div>
            <div class="chart-side">
                <div class="chart-wrapper"><canvas id="macroChart"></canvas></div>
                <div style="margin-top:20px; text-align:center;"><label>Sporcu</label><p id="r-name" style="font-weight:800;"></p></div>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-main" style="background:#222; color:#fff;" onclick="exportFile('img')">GÖRSEL</button>
            <button class="btn btn-main" style="background:#444; color:#fff;" onclick="location.reload()">SIFIRLA</button>
        </div>
    </div>
</div>

<script>
    let goal = null, chart = null;
    Chart.register(ChartDataLabels);

    function setG(el, g) { document.querySelectorAll('.card').forEach(c => c.classList.remove('selected')); el.classList.add('selected'); goal = g; }
    
    function toggleThemes() {
        const g = document.getElementById('gen').value; const w = document.getElementById('t-wrap'); const p = document.getElementById('t-pick');
        if(g === "none") { w.style.display="none"; return; }
        w.style.display="block"; p.innerHTML = "";
        const t = { male: ["#ffffff", "#3b82f6", "#4ade80"], female: ["#ffffff", "#ff0077", "#facc15"] };
        t[g].forEach((c, i) => { let o = document.createElement('option'); o.value=c; o.innerText=`Tema ${i+1}`; p.appendChild(o); });
        applyT();
    }
    function applyT() { document.documentElement.style.setProperty('--accent', document.getElementById('t-pick').value); }

    function calc() {
        if(!goal) return alert("Hedef seç!");
        const w = +document.getElementById('w').value, h = +document.getElementById('h').value, a = +document.getElementById('a').value, f = +document.getElementById('freq').value, g = document.getElementById('gen').value;
        if(!w || !h || !a) return alert("Eksik bilgi!");

        let bmr = (10 * w) + (6.25 * h) - (5 * a) + (g === 'female' ? -161 : 5);
        let tdee = bmr * f, final, p, fa, c, dTxt, rTxt;

        if (goal === 'fat') { final = tdee - 500; p = w * 2.2; fa = w * 0.7; dTxt = "-500 kcal açık."; rTxt = "Yağ yakımı ve kas koruma."; }
        else if (goal === 'muscle') { final = tdee + 300; p = w * 1.8; fa = w * 0.8; dTxt = "+300 kcal sürplus."; rTxt = "Kas gelişimi odaklı."; }
        else { final = tdee; p = w * 2.0; fa = w * 0.8; dTxt = "Stabil denge."; rTxt = "Form koruma ve gelişim."; }
        
        c = (final - (p*4 + fa*9)) / 4;

        document.getElementById('ui-setup').style.display='none';
        document.getElementById('ui-result').classList.add('active');
        document.getElementById('out-cal').innerText = Math.round(final) + " kcal";
        document.getElementById('out-p').innerText = Math.round(p) + "g";
        document.getElementById('out-f').innerText = Math.round(fa) + "g";
        document.getElementById('out-c').innerText = Math.round(c) + "g";
        document.getElementById('l-tdee').innerText = Math.round(tdee) + " kcal";
        document.getElementById('l-diff').innerText = dTxt;
        document.getElementById('l-reason').innerText = rTxt;
        document.getElementById('r-name').innerText = document.getElementById('name').value || "ELITE ATHLETE";
        
        if(chart) chart.destroy();
        chart = new Chart(document.getElementById('macroChart'), {
            type: 'doughnut',
            data: {
                labels: ['P', 'Y', 'K'],
                datasets: [{ data: [Math.round(p*4), Math.round(fa*9), Math.round(c*4)], backgroundColor: ['#4ade80', '#facc15', '#ef4444'], borderWidth: 0 }]
            },
            options: { cutout: '75%', plugins: { legend: { display: false }, datalabels: { color: '#fff', font: { weight: 'bold' } } } }
        });
    }

    async function exportFile(type) {
        const area = document.getElementById('report-area');
        
        // MOBİL DÜZELTME: Render sırasında alanı genişletiyoruz
        const originalStyle = area.style.cssText;
        area.style.width = "1000px"; // Masaüstü genişliğine zorla
        area.style.position = "fixed";
        area.style.left = "-10000px"; // Ekrandan gizle ama render edilsin
        
        const canvas = await html2canvas(area, {
            backgroundColor: '#000',
            scale: 2,
            logging: false,
            useCORS: true,
            width: 1000 // Çıktı genişliğini sabitle
        });

        area.style.cssText = originalStyle; // Eski haline getir

        if(type === 'img') {
            let link = document.createElement('a');
            link.download = 'Analiz.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        } else {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('l', 'mm', 'a4');
            const imgData = canvas.toDataURL('image/png');
            pdf.addImage(imgData, 'PNG', 10, 10, 277, 0);
            pdf.save("Analiz-Raporu.pdf");
        }
    }
</script>
</body>
</html>
